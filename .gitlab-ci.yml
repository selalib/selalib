image: pnavaro/selalib

ubuntu-mpich:
  stage: build
  allow_failure: true
  script: 
    - mkdir -p build
    - cd build && cmake -DCMAKE_BUILD_TYPE=Release -DHDF5_PARALLEL_ENABLED=ON .. && make -j
  only:
    - master
    - develop
  tags:
    - ubuntu
    - mpich
    
fedora-openmpi:
  stage: build
  allow_failure: true
  script: 
    - mkdir -p build
    - source /etc/profile.d/modules.sh && module load mpi/openmpi-x86_64
    - cd build && cmake -DCMAKE_BUILD_TYPE=Debug -DHDF5_PARALLEL_ENABLED=ON .. && make -j
  only:
    - master
    - develop
  tags:
    - fedora
    - openmpi

ubuntu-build:
  stage: build
  script:
    - mkdir -p build
    - cd build && cmake .. -DHDF5_PARALLEL_ENABLED=ON && make -j
  artifacts:
    paths:
      - build
  tags:
    - large

ubuntu-test:
  stage: test
  allow_failure: true
  script:
    - cd build && make test
  artifacts:
    paths:
      - build
  tags:
    - docker

pages:
  stage: deploy
  script:
    - cd build && make doc-dev
    - cd  ../doc && make
    - mv build/html ../public
    - mv ../build/doc/html ../public/doc
  artifacts:
    paths:
      - public
  only:
    - develop
    - master
  tags:
    - docker
