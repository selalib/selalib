! TODO: Use input from file to initialize and compare
! Unit test for antisymmetric splitting with coordinate transformation
! author: Benedikt Perse, IPP
program test_time_propagator_pic_3d3v_vm_clamped_cef_trafo
  !+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#include "sll_memory.h"
#include "sll_working_precision.h"

  use sll_mpi, only: &
       MPI_SUM

  use sll_m_collective, only: &
       sll_s_boot_collective, &
       sll_o_collective_allreduce, &
       sll_s_halt_collective, &
       sll_v_world_collective

  use sll_m_constants, only: &
       sll_p_pi, sll_p_twopi

  use sll_m_time_propagator_pic_vm_3d3v_cef_trafo, only: &
       sll_t_time_propagator_pic_vm_3d3v_cef_trafo

  use sll_m_time_propagator_pic_vm_3d3v_cl_helper, only: &
       sll_p_boundary_particles_periodic, &
       sll_p_boundary_particles_singular, &
       sll_p_boundary_particles_reflection, &
       sll_p_boundary_particles_absorption

  use sll_m_particle_mesh_coupling_spline_cl_3d_feec, only: &
       sll_t_particle_mesh_coupling_spline_cl_3d_feec

  use sll_m_maxwell_3d_base, only: &
       sll_c_maxwell_3d_base

  use sll_m_maxwell_clamped_3d_trafo, only: &
       sll_t_maxwell_clamped_3d_trafo

  use sll_m_particle_group_3d3v, only: &
       sll_t_particle_group_3d3v

  use sll_m_particle_group_base, only: &
       sll_t_particle_array

  use sll_m_3d_coordinate_transformations

  use sll_m_mapping_3d, only: &
       sll_t_mapping_3d

  use sll_m_splines_pp, only: &
       sll_p_boundary_periodic, &
       sll_p_boundary_clamped, &
       sll_p_boundary_clamped_square, &
       sll_p_boundary_clamped_cubic


  implicit none
  !+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

  ! Tolerance for comparison of real numbers: set it here!
  sll_real64, parameter :: EQV_TOL = 5.5e-10_f64

  ! Abstract particle group
  class(sll_t_particle_array), pointer :: particle_group
  class(sll_t_particle_group_3d3v), pointer :: pg

  ! Arrays for the fields
  sll_real64, allocatable :: phi(:), efield(:), efield_ref(:)
  sll_real64, allocatable :: bfield(:), bfield_ref(:)
  sll_real64, allocatable :: rho(:), rho_local(:)

  ! Abstract kernel smoothers
  type(sll_t_particle_mesh_coupling_spline_cl_3d_feec), pointer :: particle_mesh_coupling

  ! Maxwell solver 
  ! Abstract 
  class(sll_c_maxwell_3d_base), pointer :: maxwell_solver

  ! Specific time propagator
  type(sll_t_time_propagator_pic_vm_3d3v_cef_trafo) :: propagator

  type(sll_t_mapping_3d), pointer :: map  

  ! Parameters
  sll_int32  :: n_particles
  sll_real64 :: eta_min(3), eta_max(3), domain(3,3), domain_logical(3,3)
  sll_int32  :: num_cells(3)
  sll_real64 :: delta_t
  sll_int32  :: degree_smoother(3), boundary(3)
  sll_int64  :: rnd_seed
  sll_real64 :: params(6)
  ! Helper 
  sll_int32  :: i_part
  sll_real64 :: xi(3), wi(1)
  logical    :: passed
  sll_real64 :: error
  sll_int32  :: ierr,  n_total0, n_total1   ! error code for SLL_ALLOCATE

  ! Reference
  sll_real64, allocatable :: particle_info_ref(:,:)
  sll_real64, allocatable :: particle_info_check(:,:)

  call sll_s_boot_collective()

  ! Set parameters
  n_particles = 2!10
  eta_min = 0.0_f64
  eta_max = sll_p_twopi
  num_cells = [8, 8, 2]
  delta_t = 0.1_f64
  degree_smoother = [3, 3, 1]
  passed = .TRUE.
  rnd_seed = 10
  
  if( degree_smoother(1) == 2 ) then
     boundary = [ sll_p_boundary_clamped_square, sll_p_boundary_periodic, sll_p_boundary_periodic]
  else if( degree_smoother(1) == 3 ) then
     boundary = [ sll_p_boundary_clamped_cubic, sll_p_boundary_periodic, sll_p_boundary_periodic]
  else
     boundary = [ sll_p_boundary_clamped, sll_p_boundary_periodic, sll_p_boundary_periodic]
  end if

  !Initialize mapping
  params = 0._f64
  params(1) = sll_p_twopi
  params(2) = sll_p_twopi
  params(3) = sll_p_twopi
  params(4) = 0.05_f64
  params(5) = 0.05_f64

  allocate(map)
  call map%init( params,&
       sll_f_colbound_x1,&
       sll_f_colbound_x2,&
       sll_f_colbound_x3,&
       sll_f_colbound_jac11,&
       sll_f_colbound_jac12,&
       sll_f_colbound_jac13,&
       sll_f_colbound_jac21,&
       sll_f_colbound_jac22,&
       sll_f_colbound_jac23,&
       sll_f_colbound_jac31,&
       sll_f_colbound_jac32,&
       sll_f_colbound_jac33,&
       sll_f_colbound_jacobian, flag2d = .true., Lx = params(1:3))


  domain(:,1) = eta_min
  domain(:,2) = eta_max
  domain(:,3) = eta_max - eta_min

  domain_logical(:,1) = 0._f64
  domain_logical(:,2) = 1._f64
  domain_logical(:,3) = eta_max - eta_min

  ! Initialize
  allocate(pg)
  call pg%init(n_particles, &
       n_particles, -1.0_f64, 1.0_f64, 1)
  allocate( particle_group)
  particle_group%n_species = 1
  allocate( particle_group%group(1), source=pg )

  call particle_group%group(1)%set_common_weight (1.0_f64)


  SLL_ALLOCATE(particle_info_ref(7, n_particles), ierr)
  SLL_ALLOCATE(particle_info_check(7, n_particles), ierr)
  particle_info_ref = 0.0_f64
  particle_info_ref = reshape([0.98_f64, 0.42_f64, 0.17_f64,  &
       1.53_f64,  0.13_f64, -1.64_f64, 6.2832_f64, &
       0.01_f64,  0.77_f64,  0.35_f64, &
       -1.53_f64, -0.13_f64, 1.64_f64, 6.2832_f64 ], [7, n_particles])

  ! Initialize particles from particle_info_ref
  xi = 0.0_f64
  do i_part = 1, n_particles
     xi = particle_info_ref(1:3, i_part) 
     call particle_group%group(1)%set_x(i_part, xi)
     xi = particle_info_ref(4:6, i_part)
     call particle_group%group(1)%set_v(i_part, xi)
     xi(1) = particle_info_ref(7, i_part)
     call particle_group%group(1)%set_weights(i_part, xi(1))
  end do

  call particle_group%group(1)%set_common_weight (1.0_f64)

  ! Initialize kernel smoother
  allocate(particle_mesh_coupling)
  call particle_mesh_coupling%init( num_cells, domain_logical(:,1:2), &
       degree_smoother, boundary )

  ! Initialize Maxwell solver
  allocate( sll_t_maxwell_clamped_3d_trafo :: maxwell_solver )
  select type ( maxwell_solver )
  type is ( sll_t_maxwell_clamped_3d_trafo )
     call maxwell_solver%init( domain(:,1:2), num_cells, degree_smoother, boundary, map, mass_tolerance=1d-12, poisson_tolerance=1d-12, solver_tolerance=1d-12 )
  end select

  n_total0 = maxwell_solver%n_total0
  n_total1 = maxwell_solver%n_total1

  SLL_ALLOCATE(phi(n_total0),ierr)
  SLL_ALLOCATE(efield(n_total1+2*n_total0),ierr)
  SLL_ALLOCATE(bfield(n_total0+2*n_total1),ierr)
  SLL_ALLOCATE(efield_ref(n_total1+2*n_total0),ierr)
  SLL_ALLOCATE(bfield_ref(n_total0+2*n_total1),ierr)
  SLL_ALLOCATE(rho(n_total0),ierr)
  SLL_ALLOCATE(rho_local(n_total0),ierr)

  rho_local = 0.0_f64
  do i_part = 1,n_particles
     xi = particle_group%group(1)%get_x(i_part)
     wi(1) = particle_group%group(1)%get_charge( i_part)
     call particle_mesh_coupling%add_charge(xi, wi(1), degree_smoother, rho_local)
  end do
  ! MPI to sum up contributions from each processor
  rho = 0.0_f64
  call sll_o_collective_allreduce( sll_v_world_collective, &
       rho_local, &
       n_total0, MPI_SUM, rho)

  ! Solve Poisson problem
  call maxwell_solver%compute_E_from_rho( rho, efield)
  bfield = 0._f64
  bfield(n_total0+n_total1+1:n_total0+2*n_total1) = params(1)

  call propagator%init( maxwell_solver, &
       particle_mesh_coupling, particle_group, &
       phi, efield, bfield, &
       domain(:,1), domain(:,3), map=map, boundary_particles=sll_p_boundary_particles_reflection, iter_tolerance=1d-10, max_iter=0 )

  call propagator%operatorHp( delta_t )
  ! Compare to reference
  ! Particle information after advect_x application
  particle_info_check(:,1) = [0.994904996676037_f64, 0.422813311291097_f64, 0.143898589332929_f64,  &
       -1.2239398911599892_f64, -0.927238449821443_f64, -1.63999999999999_f64, -6.2832_f64 ]
  particle_info_check(:,2) = [1.64054262438696E-002_f64, 0.765876265788995_f64, 0.376101410667070_f64, &
       1.53_f64, -0.13_f64, 1.63999999999999_f64, -6.2832_f64 ]
  
  ! Compare computed values to reference values
  do i_part=1,n_particles
     xi = particle_group%group(1)%get_x(i_part)
     if( maxval(abs(xi-particle_info_check(1:3,i_part))) > EQV_TOL ) then
        passed = .FALSE.
        print*, 'error x, Hp', maxval(abs(xi-particle_info_check(1:3,i_part)))
     end if
     xi = particle_group%group(1)%get_v(i_part)
     if( maxval(abs(xi-particle_info_check(4:6,i_part))) > EQV_TOL ) then
        passed = .FALSE.
        print*, 'error v, Hp', maxval(abs(xi-particle_info_check(4:6,i_part)))
     end if
     xi(1:1) = particle_group%group(1)%get_charge(i_part)
     if( abs(xi(1)-particle_info_check(7,i_part)) > EQV_TOL) then
        passed = .FALSE.
        print*, 'error wi, Hp', abs(xi-particle_info_check(7,i_part))
     end if
  end do
 
  efield_ref = [ 1.86020272753757_f64,-0.78295554322540162_f64, 0.31117599088356696_f64, -9.9477206823176095E-002_f64 , &
       6.24236880609141E-002_f64,-1.5163614983003341E-003_f64,-1.5226934728236816E-003_f64, 3.0594015493751289E-002_f64, &
      -0.271447008740536_f64, 0.20509569850430176_f64, -2.6949241446376702_f64, 1.3052348089957744_f64, -0.38931203458456887_f64,&
       0.194311215382807_f64, -6.3561725579127745E-002_f64, 4.1651143064885834E-002_f64, 2.1849782705538220E-002_f64, &
      -3.819506375276629E-002_f64, 0.21184377892473399_f64,-0.89026501388204105_f64,4.9208230858869877_f64, &
      -2.226968629037035_f64, 0.76338234113988257_f64,-0.30897109913018173_f64, 0.14889761790202244_f64, &
      -6.230911517488188E-002_f64, 5.4591125665701311E-002_f64,-6.2356439192850305E-002_f64, 7.6697885256106144E-002_f64, &
      -0.408950885894592_f64, -9.1340952356319267_f64,4.5655718573647022_f64, -1.4355287822246972_f64, &
       0.612226341328410_f64, -0.28324535294389086_f64, 0.12759146886734440_f64, -6.3426704903149916E-002_f64, &
       2.496748163248463E-002_f64, -0.13802888496755930_f64, -8.6759847117111877E-003_f64, 21.082092068175641_f64, &
      -9.964230586518343_f64, 3.0024661650778275_f64, -1.4379330968196991_f64, 0.60806969994824500_f64,-0.29231334388144448_f64, &
       0.122582738338943_f64, -9.6934240361954110E-002_f64, 1.1395435763992141E-002_f64, -0.12089938645523748_f64, &
      -4.820453737021478_f64, 2.5551081045019126_f64,-0.96192829800884039_f64, 0.37138657090252036_f64,-0.20517520312770721_f64,&
       7.665572788154516E-002_f64,-5.7616160373509591E-002_f64,-8.2278394021770423E-003_f64,-5.0722515479924749E-002_f64,&
      -4.640049546789476E-002_f64, 2.5014435146915206_f64, -1.0267015169680933_f64, 0.42636904497486894_f64,&
      -0.174164538255734_f64,7.7674594287689996E-002_f64,-4.1622275655727937E-002_f64,-2.0053561607232284E-003_f64,&
      -2.771667191198601E-002_f64,-6.3403732916361255E-002_f64, 2.2382762763320633E-002_f64,-1.6663342008416884_f64,&
       0.805444196196971_f64,-0.24956853437677645_f64, 0.12973014577743688_f64, -4.3071270028108677E-002_f64, &
       2.117062962756383E-002_f64,-1.0056026957760561E-002_f64,-4.4227629990949410E-002_f64, 1.9046068865947789E-002_f64, &
      -0.205194023929164_f64,-0.33435473263255627_f64, 0.18544989373249679_f64, -3.6438935462443089E-002_f64, &
       7.358327127160303E-002_f64,-4.3861628023967376E-002_f64,0.14185051625273787_f64,-0.11673788568226307_f64, &
       0.420196336290841_f64, -1.5489070232238462_f64, -3.6515217028031879_f64, 0.56876704450936644_f64,&
      -0.173079080467583_f64, 0.10811501632579411_f64, -2.3813788757386000E-002_f64, 6.8425971512027492E-002_f64,&
      -3.621775971587684E-002_f64,0.24790479931668352_f64, -4.4459331673125435E-002_f64, 3.0260280333089131_f64, &
       2.788785351919596_f64,-0.85303299441448999_f64, 0.36431049964665901_f64, -4.9366476370414664E-002_f64, &
      -1.181551689025903E-002_f64,0.15857330472367206_f64,-0.28554457212583428_f64, 0.63346837509691711_f64, &
      -0.950801470325457_f64,2.5561415082989485_f64, -1.5916146616819487_f64,1.7374912154280420_f64, &
      -0.607050630856027_f64, 0.24051396161190899_f64, -6.6976870989860035E-002_f64, 2.1369966240542392E-002_f64,&
       4.997009547988621E-002_f64,-7.0137729566833534E-002_f64,0.19628947594978674_f64,-0.68142563657604960_f64, &
      -1.179111961537454_f64, -3.3975183293797149_f64,1.4583342356472091_f64,-0.44671309928041525_f64, &
       0.203347390429304_f64, -7.4397842868467096E-002_f64, 1.8525979165945256E-002_f64, 2.4394082978915245E-002_f64, &
      -8.922822109958671E-002_f64,0.14472448678259239_f64, 0.21398269861267760_f64,1.0596741897208408_f64, &
      -0.322412641295935_f64, 0.15657454547681995_f64, -4.7669709831836757E-002_f64, 1.8641571408000913E-002_f64, &
       8.305304605721111E-004_f64,-3.6564333490729302E-002_f64, 1.8872666796203572E-002_f64,-9.4271075733082965E-002_f64, &
       0.224055947100297_f64,-0.44017809432648219_f64, 0.22468134170971571_f64, -3.8498657717394094E-002_f64, &
       3.910827762818034E-002_f64,-5.5402641980784777E-003_f64,-7.1265306003132078E-004_f64,-8.0571700091018467E-003_f64, &
      -3.334732942708879E-002_f64, -0.19198369037745611_f64,-0.87853445146463405_f64, 0.38332720490721583_f64, &
      -9.655047676558363E-002_f64, 7.6970349144830641E-002_f64,-1.0153639321042643E-002_f64, 3.7395401241690586E-002_f64, &
      -2.217681579736811E-002_f64, 5.1558599157072060E-002_f64, -0.12529883614530413_f64, 0.43775467905955079_f64, &
       1.621565280943924_f64, -0.0000000000000000_f64, 0.42342483364363614_f64,-0.27869339110638974_f64, 0.11345246777893246_f64, &
      -5.123315309483388E-002_f64, 3.0821667559479737E-002_f64, 1.3941491807653465E-002_f64, 2.7409106525441328E-002_f64, &
       8.325692327026397E-002_f64,-7.0822519706101414E-002_f64,-0.0000000000000000_f64, -0.0000000000000000_f64, &
      -0.518932942389567_f64, 0.28843433843038219_f64,-0.10983016551013675_f64,5.1445050638864634E-002_f64, &
      -1.371928864814770E-002_f64, 3.4244300139829754E-003_f64, 2.9929222073518183E-002_f64,-1.4343154956671392E-002_f64, &
       0.242760759418322_f64, -0.0000000000000000_f64, -0.0000000000000000_f64, 0.89330246525563062_f64,-0.40666081113888281_f64, &
       0.184956974193907_f64, -6.5211050325061207E-002_f64, 2.8369920514209803E-002_f64,-2.3645283426553677E-002_f64, &
      -2.751866153543304E-003_f64,-4.9808290318997521E-002_f64,-8.1740912899073065E-002_f64,-0.0000000000000000_f64, &
      -0.000000000000000_f64, -1.7012150309625751_f64, 0.84346441265181404_f64,-0.29647435109367393_f64, &
       0.146658410019941_f64, -5.7025356005794337E-002_f64, 1.9842587103546281E-002_f64,-3.8063095705114756E-002_f64, &
       7.961221441031224E-003_f64,-9.7501981837279261E-002_f64,-0.0000000000000000_f64, -0.0000000000000000_f64, &
       4.309136022331935_f64, -1.6196951113343065_f64, 0.84989156864704640_f64,-0.33807221613183785_f64, &
       0.157996067378731_f64, -7.5772720293354523E-002_f64, 1.7166550768765679E-002_f64,-4.7849216940494529E-002_f64, &
       1.051666273982520E-002_f64,-0.0000000000000000_f64, -0.0000000000000000_f64, -5.0452115500387658_f64, &
       2.547870062772929_f64, -1.2590335509962352_f64, 0.59971040196916758_f64,-0.30652778363175137_f64, &
       0.143766710048195_f64, -9.7261938220169736E-002_f64, 3.9091669158907827E-002_f64,-3.6192830020312705E-002_f64, &
      -0.000000000000000_f64, -0.0000000000000000_f64,1.1931014104444819_f64, -1.0406048418562202_f64, &
       0.365038880092653_f64,-0.23967875600946351_f64, 0.10202992462438851_f64, -6.1961416512966556E-002_f64, &
       2.782538751297038E-002_f64,-2.1641187301530619E-002_f64,-2.2104936702875963E-003_f64,-0.0000000000000000_f64, &
      -0.000000000000000_f64,-0.59850889201755320_f64, 0.39129683813850236_f64,-0.20556229105736115_f64, &
       8.659787351513301E-002_f64,-4.3428955712633603E-002_f64, 3.3194106236490856E-002_f64, 9.9077870915480065E-003_f64, &
       1.395184476879605E-002_f64, 3.9733395169574991E-002_f64,-0.0000000000000000_f64, -0.0000000000000000_f64, &
      -5.067884614403375E-002_f64, 4.2127530685174469E-002_f64,-3.8890346924657662E-002_f64, 6.3791659114964552E-002_f64,&
      -9.985776717480264E-002_f64,0.27447667540573423_f64,-0.39921592604237433_f64,1.3726536353807115_f64, &
      -2.384485978018041_f64, -0.0000000000000000_f64, -0.0000000000000000_f64,4.7846412779799750E-002_f64, &
      -3.711421796541453E-002_f64, 4.0982824187204406E-002_f64,-6.5225809355885567E-002_f64,0.15177532044690978_f64, &
      -0.338297380976115_f64, 0.84563067151269755_f64, -1.7216584928908290_f64,5.6550105922823697_f64, &
      -0.000000000000000_f64, -0.0000000000000000_f64, -8.9621257315827027E-002_f64, 9.2167070381702659E-002_f64, &
      -8.375382604566085E-002_f64,0.12927629026860790_f64,-0.23167340794775887_f64, 0.39822912013111245_f64, &
      -0.873595018786452_f64,1.4311721771938957_f64, -4.0468004209967212_f64, -0.0000000000000000_f64, &
      -0.000000000000000_f64, 0.11003932730751076_f64, -2.6023899830422883E-002_f64, 3.3800336176945528E-003_f64, &
       3.998592966552439E-002_f64, -0.10568310691707748_f64, 0.20696216644086635_f64,-0.53289142566952841_f64,&
       0.942757663507701_f64, -2.2169813257272941_f64, -0.0000000000000000_f64, -0.0000000000000000_f64, &
      -0.257520203710866_f64, 0.12809484699749238_f64, -3.1871429367855822E-002_f64, 6.4828182982008646E-003_f64,&
       2.418519516827255E-002_f64,-9.2669845022246233E-002_f64,0.14982222729751543_f64,-0.52035221945388144_f64,&
       0.860032732324397_f64, -0.0000000000000000_f64, -0.0000000000000000_f64, 0.49360823501523593_f64, &
      -0.309413491261878_f64, 0.14175091777838733_f64, -7.7869845255029324E-002_f64, 3.2966936598171778E-002_f64, &
      -2.694813537149729E-002_f64,-3.1119104541254834E-002_f64, 1.8082930924637773E-002_f64, -0.12529501126530454_f64, &
      -0.000000000000000_f64, -0.0000000000000000_f64,-0.16619403677212571_f64,9.9106447189977548E-002_f64, &
      -7.457373224800023E-002_f64, 3.6299036314104000E-002_f64,-4.9477847882711000E-002_f64, 6.5979529296122164E-002_f64, &
      -0.125977582721264_f64, 0.26065752155117455_f64,-0.54386514000811548_f64, -0.0000000000000000_f64, &
      -0.000000000000000_f64,7.3756742003054251E-002_f64,-6.6139975223366093E-002_f64, 3.3952257519403790E-002_f64, &
      -4.330944504623122E-002_f64, 7.7272493122804736E-002_f64, -0.11177793955947618_f64, 0.30356757897512820_f64, &
      -0.573970339535325_f64,1.2939415687626958_f64, -0.0000000000000000_f64, -0.0000000000000000_f64, &
       0.989294177044146_f64,-0.71681083312990090_f64, 0.41840012066360144_f64,-0.35597089416332617_f64, &
       0.448687721338063_f64,-0.75051524239036793_f64,1.3649105043762750_f64, -2.9687752170617800_f64, &
       4.532279359218027_f64, -0.0000000000000000_f64, -0.0000000000000000_f64, -1.4844305591227847_f64, &
       1.088948528680230_f64,-0.65224189934837251_f64, 0.58932261652480622_f64,-0.79044274995652763_f64, &
       1.330548204458046_f64, -2.5713394970504679_f64,5.3080998652345883_f64, -8.7732755542869718_f64, &
      -0.000000000000000_f64, -0.0000000000000000_f64,2.4890657984013580_f64, -1.6082066011619625_f64, &
       0.732819543678291_f64,-0.30107962731610000_f64,1.1128155565065082E-002_f64,0.27817471092497681_f64, &
      -0.743122303211485_f64,1.6024003764296135_f64, -2.6520691021065592_f64, -0.0000000000000000_f64, &
      -0.000000000000000_f64, -4.7803727883233895_f64,3.1477325828897831_f64, -1.4550203100894583_f64, &
       0.713320224259196_f64,-0.27976980298867116_f64, -3.9044225272343462E-002_f64,0.37952186025885382_f64,&
      -1.037498394904403_f64,1.6844696167168451_f64, -0.0000000000000000_f64, -0.0000000000000000_f64, &
       9.897426038728008_f64, -6.3370235813612270_f64,3.0514936111342532_f64, -1.5414712190125355_f64, &
       0.788669241907140_f64,-0.36217473203209327_f64,7.8485660227989543E-002_f64,0.19692442501920376_f64, &
      -0.522950324409724_f64, -0.0000000000000000_f64, -0.0000000000000000_f64, -2.7587860773596100_f64, &
       1.914152276369311_f64,-0.88530598754123946_f64, 0.48232640724484005_f64,-0.26365595915116502_f64, &
       0.164811846692449_f64,-0.13505086947678435_f64, 0.17113183938714771_f64,-0.21234845149307857_f64, &
      -0.000000000000000_f64, -0.0000000000000000_f64,1.3036173504219450_f64,-0.88740341122537791_f64, &
       0.449323752800587_f64,-0.26095218383956947_f64, 0.19812750919450006_f64,-0.21596915851119053_f64, &
       0.329048047801833_f64,-0.65188980552496001_f64, 0.99313938443088490_f64, -0.0000000000000000_f64, &
      -0.000000000000000_f64,-0.91836767795156715_f64, 0.64966030451123524_f64,-0.34543513373579238_f64, &
       0.249786785246799_f64,-0.26209182658480540_f64, 0.38166891198895742_f64,-0.69311180011046059_f64, &
       1.424068290142926_f64, -2.2207902391992023_f64, -0.0000000000000000_f64, -0.0000000000000000_f64, &
       -5.23349349928525E-002_f64, 3.2343494784510866E-002_f64,-1.8069211513695289E-002_f64, &
       1.491006369714970E-002_f64,-1.8867650864529198E-002_f64, 4.8379298787115249E-002_f64, &
      -6.310299091250995E-002_f64,0.24138446816754727_f64,-0.38818741895768427_f64, -0.0000000000000000_f64, &
      -0.000000000000000_f64,8.8149542758626923E-002_f64,-5.0638259003593235E-002_f64, 2.2651237177731171E-002_f64, &
      -1.858291594147675E-002_f64, 2.8898164835446438E-002_f64,-4.7546339151183961E-002_f64,0.15965467423639884_f64, &
      -0.223188049360506_f64,1.0189561169981289_f64, -0.0000000000000000_f64, -0.0000000000000000_f64, &
      -0.171870888704830_f64,7.6340875511175701E-002_f64,-3.4418606245596353E-002_f64, 3.0305957037253944E-003_f64,&
       1.821900592896155E-002_f64,-4.0967933512111358E-002_f64,0.11276199626609343_f64,-0.15603041596416845_f64, &
       0.392099078645499_f64, -0.0000000000000000_f64, -0.0000000000000000_f64, 0.34112304835096485_f64, &
      -0.185311344726466_f64,6.3409317930496367E-002_f64,-3.5232407726937948E-002_f64, 1.0025259917612078E-002_f64, &
       7.241246374060324E-003_f64,-1.5368952531370045E-002_f64, 8.0918732698750842E-002_f64, -0.13051887926417075_f64,&
      -0.000000000000000_f64, -0.0000000000000000_f64,-0.90485343372540161_f64, 0.32766207856987267_f64, &
      -0.196847283587372_f64,7.3943094409212928E-002_f64,-3.7891064135542205E-002_f64, 1.4337484085213268E-002_f64, &
       4.588147037837900E-003_f64,-1.4206062123941363E-002_f64, 4.9383450197153990E-002_f64,-0.0000000000000000_f64, &
      -0.000000000000000_f64, 0.11779310649197933_f64,-0.13546827252070259_f64,2.9493806229979932E-002_f64, &
      -2.875677763986615E-002_f64, 9.4716522556821999E-003_f64,-5.3788405755263065E-003_f64, 4.2693207495207771E-003_f64, &
      -2.860448735575497E-003_f64, 1.5408159700664205E-002_f64,-0.0000000000000000_f64, -0.0000000000000000_f64, &
      -5.943179171294694E-002_f64, 3.6032563631318119E-002_f64,-2.3729539283397681E-002_f64, 8.1038562627475507E-003_f64, &
      -7.154271600771797E-003_f64, 8.0409700959687101E-003_f64,-1.1971496216675665E-002_f64, 3.3447503864706296E-002_f64, &
      -8.086508094670813E-002_f64,-0.0000000000000000_f64, -0.0000000000000000_f64,4.1405427114159780E-002_f64, &
      -3.149997464374115E-002_f64, 1.2402685052007409E-002_f64,-9.7057499639530559E-003_f64, 1.0892166801091781E-002_f64, &
      -1.404818421064380E-002_f64, 4.0942602205223014E-002_f64,-7.9314447220032988E-002_f64,0.19215014611245049_f64, -0.0000000000000000_f64 ]

  
  error = maxval(abs(efield-efield_ref))
  if (error> EQV_TOL) then
     passed = .FALSE.
     print*, 'e field wrong in Hp.', error
  end if

  if (passed .EQV. .FALSE.) then
     print*, 'Error in Hp.'
  end if
  
  ! Reset particle info
  ! Initialize particles from particle_info_ref
  xi = 0.0_f64
  do i_part =1, n_particles
     xi = particle_info_ref(1:3, i_part) 
     call particle_group%group(1)%set_x(i_part, xi)
     xi = particle_info_ref(4:6, i_part)
     call particle_group%group(1)%set_v(i_part, xi)
     xi(1) = particle_info_ref(7, i_part)
     call particle_group%group(1)%set_weights(i_part, xi(1))
  end do

  call propagator%operatorHB( delta_t )
  ! Compare to reference
  ! Particle information after HB application 
  particle_info_check(:,1) = [ 0.98_f64, 0.42_f64, 0.17_f64,  &
     1.5267829805681130_f64, 0.16350452668825111_f64, -1.6399999999999999_f64, -6.2832_f64 ]
  particle_info_check(:,2) = [0.01_f64,  0.77_f64,  0.35_f64, &
      -1.5275302537032702_f64, -0.15636919140681993_f64, 1.6399999999999999_f64, -6.2832_f64 ]

  ! Compare computed values to reference values
  do i_part=1,n_particles
     xi = particle_group%group(1)%get_x(i_part)
     if( maxval(abs(xi-particle_info_check(1:3,i_part))) > EQV_TOL ) then
        passed = .FALSE.
        print*, 'error x, HB', maxval(abs(xi-particle_info_check(1:3,i_part)))
     end if
     xi = particle_group%group(1)%get_v(i_part)
     if( maxval(abs(xi-particle_info_check(4:6,i_part))) > EQV_TOL ) then
        passed = .FALSE.
        print*, 'error v, HB', maxval(abs(xi-particle_info_check(4:6,i_part)))
     end if
     xi(1:1) = particle_group%group(1)%get_charge(i_part)
     if( abs(xi(1)-particle_info_check(7,i_part)) > EQV_TOL) then
        passed = .FALSE.
        print*, 'error wi, HB', abs(xi-particle_info_check(7,i_part))
     end if
  end do


  efield_ref = [ 1.8601963767844405_f64,     -0.77997066205289711_f64,      0.31989043863068745_f64,      -8.5566383734119941E-002_f64, &
       8.0476953036831084E-002_f64,  1.9919317454527241E-002_f64,  2.1657339430791987E-002_f64,  5.5974322841799332E-002_f64, &
       -0.24654287558548493_f64,      0.23351434996525725_f64,      -2.6893030859418521_f64,       1.3131109115668858_f64, &
       -0.37438717491558338_f64,     0.21742712488194943_f64,     -3.0302168251738038E-002_f64, 8.5025923004737033E-002_f64, &
       7.6690076066863927E-002_f64, 2.2919930926525875E-002_f64,0.28154354095017481_f64,    -0.82920682629090403_f64,   &
       4.9294340761181754_f64,     -2.2169965845272603_f64,     0.77633772236880716_f64,    -0.29258069159658023_f64,   &
       0.16772116513573820_f64,     -4.2527401654631460E-002_f64, 7.2250767669119309E-002_f64,-4.9902141783364773E-002_f64, &
       8.1161935493975573E-002_f64, -0.40895132008505775_f64,     -9.1273230484313927_f64,      4.5712802855778341_f64, &
       -1.4367393151701755_f64,     0.60221274262585534_f64,    -0.30563815684548029_f64,      9.2506581271325106E-002_f64, &
       -0.11297986721468992_f64,     -3.3227456597507796E-002_f64, -0.20688824887556059_f64,     -6.9712726049844576E-002_f64, &
       21.082126054533106_f64,     -9.9684584297005205_f64,      2.9904010281161337_f64,     -1.4567948548689418_f64,    &
       0.58445236193211070_f64,    -0.31910858329688474_f64,      9.5059772802891046E-002_f64, -0.12511902840468164_f64, &
       -1.4486352274880000E-002_f64,-0.14930812568363178_f64,      -4.8273371988649414_f64,       2.5457601255083526_f64, &
       -0.97293389361914895_f64,      0.35959881222936141_f64,     -0.21716392701374682_f64,       6.4733392512269158E-002_f64, &
       -6.9816512000905079E-002_f64, -2.0114654666699129E-002_f64, -6.3263490308076514E-002_f64, -5.7288018351229070E-002_f64, &
       2.4927250628952518_f64,      -1.0339326867388154_f64,      0.42089669618552200_f64,     -0.17808164384640676_f64,  &
       7.4689114536555523E-002_f64, -4.3682864367129204E-002_f64, -3.4358505969682893E-003_f64, -2.8497426912488032E-002_f64,&
       -6.3680897095656441E-002_f64,  2.2395615043725545E-002_f64, -1.6719535663423835_f64,      0.80288239098884440_f64,  &
       -0.24829627799641152_f64,      0.13414288724743187_f64,      -3.6394643073005856E-002_f64,  2.9551644570502422E-002_f64,&
       -1.0168656351196119E-004_f64, -3.3564446924013822E-002_f64,  3.1200943076139222E-002_f64,-0.19431067735249014_f64,  &
       -0.33436108338568094_f64,      0.18843477490499591_f64,      -2.7724487715316555E-002_f64,  8.7494094360654057E-002_f64, &
       -2.5808363048043688E-002_f64, 0.16328619520557050_f64,      -9.3557852778649447E-002_f64, 0.44557664363889415_f64, &
       -1.5240028900687919_f64,      -3.6231030513422433_f64,      0.57438810320517375_f64,     -0.16520297789646357_f64,  &
       0.12303987599477122_f64,      -6.9787925823899810E-004_f64, 0.10168552883941204_f64,       7.1570202239652977E-003_f64,&
       0.30274509267801436_f64,       1.6655663006159754E-002_f64,  3.0957277953343536_f64,       2.8498435395107435_f64, &
       -0.84442200418329183_f64,      0.37428254415642348_f64,      -3.6411095141478625E-002_f64,  4.5748906433351784E-003_f64, &
       0.17739685195739360_f64,     -0.26576285860557286_f64,      0.65112801710032708_f64,     -0.93834717291596648_f64,   &
       2.5606055585368179_f64,      -1.5916150958724233_f64,       1.7442634026285662_f64,     -0.60134220264288674_f64, &
       0.23930342866641785_f64,      -7.6990469692407276E-002_f64, -1.0228376610509800E-003_f64,  1.4885207883856617E-002_f64, &
       -0.11969089187836615_f64,      0.13809453771979344_f64,     -0.75028500048405211_f64,      -1.2401487028755780_f64,    &
       -3.3974843430222421_f64,       1.4541063924650264_f64,     -0.45877823624209696_f64,      0.18448563238005330_f64, &
       -9.8015180884597250E-002_f64, -8.2692602494905086E-003_f64, -3.1288825571401009E-003_f64,-0.11741300914231706_f64, &
       0.11884269874372307_f64,      0.18557395938427440_f64,       1.0527907278773729_f64,     -0.33176062028949238_f64, &
       0.14556894986650418_f64,      -5.9457468504988772E-002_f64,  6.6528475219556835E-003_f64, -1.1091804908704830E-002_f64, &
       -4.8764685118123222E-002_f64,  6.9858515316834884E-003_f64,-0.10681205056123726_f64,      0.21316842421696983_f64, &
       -0.44889654612274693_f64,      0.21745017193899241_f64,      -4.3971006506737548E-002_f64,  3.5191172037502078E-002_f64, &
       -8.5257439492051820E-003_f64, -2.7732417714330612E-003_f64, -9.4876644453475434E-003_f64, -3.4128084427590862E-002_f64, &
       -0.19226085455674835_f64,     -0.87852159918423656_f64,      0.37770783940651415_f64,      -9.9112281973707486E-002_f64,&
       7.8242605525191314E-002_f64, -5.7408978510412817E-003_f64,  4.4072028196784449E-002_f64, -1.3795800854430032E-002_f64, &
       6.1512939551320388E-002_f64,-0.11463565307836976_f64,      0.44990955326973830_f64,       1.6324486275206085_f64, &
       0.0000000000000000_f64,      0.42710701617353120_f64,     -0.27706763682555324_f64,      0.11650583030146144_f64,  &
       -4.8486867678179731E-002_f64,  3.4287675790205696E-002_f64,  1.7101090204104118E-002_f64,  3.1321852475299027E-002_f64, &
       8.5626022316740241E-002_f64, -6.6105447037275208E-002_f64,  0.0000000000000000_f64,       0.0000000000000000_f64, &
       -0.52259127501795855_f64,      0.28700411915362339_f64,     -0.11274974415701799_f64,       4.8877811157935228E-002_f64, &
       -1.7748757833134211E-002_f64, -5.1145676927730459E-004_f64,  2.2904416247456184E-002_f64, -1.8847426441291847E-002_f64,&
       0.23000016223843067_f64,       0.0000000000000000_f64,       0.0000000000000000_f64,      0.88230767367286289_f64,   &
       -0.41210523619564871_f64,      0.17448289934167274_f64,      -7.6181808954051661E-002_f64,  1.3087848852979377E-002_f64,&
       -3.9700499017740656E-002_f64, -2.3589334361186653E-002_f64, -6.3481907502473067E-002_f64,-0.10719315307905353_f64, &
       0.0000000000000000_f64,       0.0000000000000000_f64,      -1.7159278589223239_f64,       0.83626202145063722_f64,  &
       -0.30742919857612255_f64,      0.13851976942644950_f64,      -6.2330214868405648E-002_f64,  1.8127436449023794E-002_f64, &
       -3.1287256122200444E-002_f64,  1.4122239029232573E-002_f64, -7.4628168159552061E-002_f64,  0.0000000000000000_f64,  &
       0.0000000000000000_f64,       4.3019608619181167_f64,      -1.6216276679208550_f64,      0.84811282298256274_f64,  &
       -0.33641682720804839_f64,      0.16236939273676290_f64,      -6.9670617640653118E-002_f64,  2.6487245407012080E-002_f64,&
       -4.1776046842911453E-002_f64,  2.3816111431003137E-002_f64,  0.0000000000000000_f64,       0.0000000000000000_f64,  &
       -5.0373122397160923_f64,       2.5518204649522636_f64,      -1.2531635674740225_f64,      0.60360784434782055_f64,  &
       -0.30380209620580328_f64,      0.14477362580542477_f64,      -9.8369785856593020E-002_f64,  3.7948973641821558E-002_f64,&
       -4.0469052638831896E-002_f64,  0.0000000000000000_f64,       0.0000000000000000_f64,       1.2073980283823629_f64, &
       -1.0358433062201251_f64,      0.37293433553187944_f64,     -0.23536020000203670_f64,      0.10621557484904011_f64,  &
       -5.9570603779205887E-002_f64,2.9301109827398662E-002_f64,-2.1254172863207240E-002_f64,-3.1079277892248247E-003_f64,&
       0.0000000000000000_f64,0.0000000000000000_f64,-0.58802091143008606_f64,0.39493455751813539_f64,-0.19909426485956799_f64,&
       9.0968025561152091E-002_f64,-3.8770189182782390E-002_f64,3.6676447852511514E-002_f64,1.2941663166112385E-002_f64,&
       1.5581738484053354E-002_f64,4.1442966468665923E-002_f64,0.0000000000000000_f64,0.0000000000000000_f64,&
       -4.6996663614145791E-002_f64,4.3753284966019226E-002_f64,-3.5836984402136229E-002_f64,6.6537944531626883E-002_f64,&
       -9.6391758944082473E-002_f64,0.27763627380218797_f64,-0.39530318009252008_f64,1.3750227344271955_f64,&
       -2.3797689053492275_f64,0.0000000000000000_f64,0.0000000000000000_f64,4.4188080151415857E-002_f64,&
       -3.8544437242179534E-002_f64,3.8063245540326675E-002_f64,-6.7793048836816569E-002_f64,0.14774585126192141_f64,&
       -0.34223326775937096_f64,0.83860586568663131_f64,-1.7261627643754480_f64,5.6422499951024836_f64,&
       0.0000000000000000_f64,0.0000000000000000_f64,-0.10061604889860477_f64,8.6722645324947265E-002_f64,&
       -9.4227900897901978E-002_f64,0.11830553163962140_f64,-0.24695547960898878_f64,0.38217390453992167_f64,&
       -0.89443248699409250_f64,1.4174985600104193_f64,-4.0722526611767051_f64,0.0000000000000000_f64,&
       0.0000000000000000_f64,9.5326499347772736E-002_f64,-3.3226291031612565E-002_f64,-7.5748138647448570E-003_f64,&
       3.1847289072028037E-002_f64,-0.11098796577969154_f64,0.20524701578635071_f64,-0.52611558608661957_f64,&
       0.94891868109590460_f64,-2.1941075120495648_f64,0.0000000000000000_f64,0.0000000000000000_f64,&
       -0.26469536412469519_f64,0.12616229041095678_f64,-3.3650175032349704E-002_f64,8.1382072219949222E-003_f64,&
       2.8558520526305996E-002_f64,-8.6567742369547951E-002_f64,0.15914292193576202_f64,-0.51427904935629531_f64,&
       0.87333218101556953_f64,0.0000000000000000_f64,0.0000000000000000_f64,0.50150754533791575_f64,&
       -0.30546308908255626_f64,0.14762090130061159_f64,-7.3972402876384027E-002_f64,3.5692624024123175E-002_f64,&
       -2.5941219614269786E-002_f64,-3.2226952177675405E-002_f64,1.6940235407547827E-002_f64,-0.12957123388382039_f64,&
       0.0000000000000000_f64,0.0000000000000000_f64,-0.15189741883424432_f64,0.10386798282607304_f64,&
       -6.6678276808777151E-002_f64,4.0617592321535993E-002_f64,-4.5292197658063797E-002_f64,&
       6.8370342029884776E-002_f64,-0.12450186040683718_f64,0.26104453598950172_f64,-0.54476257412705775_f64,&
       0.0000000000000000_f64,0.0000000000000000_f64,8.4244722590524804E-002_f64,-6.2502255843737475E-002_f64,&
       4.0420283717203048E-002_f64,-3.8939293000221802E-002_f64,8.1931259652664373E-002_f64,-0.10829559794346082_f64,&
       0.30660145504969594_f64,-0.57234044582007382_f64,1.2956511400617965_f64,0.0000000000000000_f64,&
       0.0000000000000000_f64,0.98929417704414635_f64,-0.71681083312990090_f64,0.41840012066360144_f64,&
       -0.35597089416332617_f64,0.44868772133806334_f64,-0.75051524239036793_f64,1.3649105043762750_f64,&
       -2.9687752170617800_f64,4.5322793592180277_f64,0.0000000000000000_f64,0.0000000000000000_f64,&
       -1.4844305591227847_f64,1.0889485286802305_f64,-0.65224189934837251_f64,0.58932261652480622_f64,&
       -0.79044274995652763_f64,1.3305482044580461_f64,-2.5713394970504679_f64,5.3080998652345883_f64,&
       -8.7732755542869718_f64,0.0000000000000000_f64,0.0000000000000000_f64,2.4890657984013580_f64,&
       -1.6082066011619625_f64,0.73281954367829150_f64,-0.30107962731610000_f64,1.1128155565065082E-002_f64,&
       0.27817471092497681_f64,-0.74312230321148565_f64,1.6024003764296135_f64,-2.6520691021065592_f64,&
       0.0000000000000000_f64,0.0000000000000000_f64,-4.7803727883233895_f64,3.1477325828897831_f64,&
       -1.4550203100894583_f64,0.71332022425919672_f64,-0.27976980298867116_f64,-3.9044225272343462E-002_f64,&
       0.37952186025885382_f64,-1.0374983949044039_f64,1.6844696167168451_f64,0.0000000000000000_f64,&
       0.0000000000000000_f64,9.8974260387280086_f64,-6.3370235813612270_f64,3.0514936111342532_f64,&
       -1.5414712190125355_f64,0.78866924190714038_f64,-0.36217473203209327_f64,7.8485660227989543E-002_f64,&
       0.19692442501920376_f64,-0.52295032440972400_f64,0.0000000000000000_f64,0.0000000000000000_f64,&
       -2.7587860773596100_f64,1.9141522763693117_f64,-0.88530598754123946_f64,0.48232640724484005_f64,&
       -0.26365595915116502_f64,0.16481184669244914_f64,-0.13505086947678435_f64,0.17113183938714771_f64,&
       -0.21234845149307857_f64,0.0000000000000000_f64,0.0000000000000000_f64,1.3036173504219450_f64,&
       -0.88740341122537791_f64,0.44932375280058728_f64,-0.26095218383956947_f64,0.19812750919450006_f64,&
       -0.21596915851119053_f64,0.32904804780183317_f64,-0.65188980552496001_f64,0.99313938443088490_f64,&
       0.0000000000000000_f64,0.0000000000000000_f64,-0.91836767795156715_f64,0.64966030451123524_f64,&
       -0.34543513373579238_f64,0.24978678524679943_f64,-0.26209182658480540_f64,0.38166891198895742_f64,&
       -0.69311180011046059_f64,1.4240682901429265_f64,-2.2207902391992023_f64,0.0000000000000000_f64,&
       0.0000000000000000_f64,-5.2334934992852515E-002_f64,3.2343494784510866E-002_f64,-1.8069211513695289E-002_f64,&
       1.4910063697149707E-002_f64,-1.8867650864529198E-002_f64,4.8379298787115249E-002_f64,-6.3102990912509954E-002_f64,&
       0.24138446816754727_f64,-0.38818741895768427_f64,0.0000000000000000_f64,0.0000000000000000_f64,&
       8.8149542758626923E-002_f64,-5.0638259003593235E-002_f64,2.2651237177731171E-002_f64,-1.8582915941476756E-002_f64,&
       2.8898164835446438E-002_f64,-4.7546339151183961E-002_f64,0.15965467423639884_f64,-0.22318804936050687_f64,&
       1.0189561169981289_f64,0.0000000000000000_f64,0.0000000000000000_f64,-0.17187088870483003_f64,&
       7.6340875511175701E-002_f64,-3.4418606245596353E-002_f64,3.0305957037253944E-003_f64,&
       1.8219005928961550E-002_f64,-4.0967933512111358E-002_f64,0.11276199626609343_f64,-0.15603041596416845_f64,&
       0.39209907864549992_f64,0.0000000000000000_f64,0.0000000000000000_f64,0.34112304835096485_f64,&
       -0.18531134472646688_f64,6.3409317930496367E-002_f64,-3.5232407726937948E-002_f64,1.0025259917612078E-002_f64,&
       7.2412463740603242E-003_f64,-1.5368952531370045E-002_f64,8.0918732698750842E-002_f64,-0.13051887926417075_f64,&
       0.0000000000000000_f64,0.0000000000000000_f64,-0.90485343372540161_f64,0.32766207856987267_f64,&
       -0.19684728358737294_f64,7.3943094409212928E-002_f64,-3.7891064135542205E-002_f64,1.4337484085213268E-002_f64,&
       4.5881470378379002E-003_f64,-1.4206062123941363E-002_f64,4.9383450197153990E-002_f64,0.0000000000000000_f64,&
       0.0000000000000000_f64,0.11779310649197933_f64,-0.13546827252070259_f64,2.9493806229979932E-002_f64,&
       -2.8756777639866150E-002_f64,9.4716522556821999E-003_f64,-5.3788405755263065E-003_f64,4.2693207495207771E-003_f64,&
       -2.8604487355754979E-003_f64,1.5408159700664205E-002_f64,0.0000000000000000_f64,0.0000000000000000_f64,&
       -5.9431791712946942E-002_f64,3.6032563631318119E-002_f64,-2.3729539283397681E-002_f64,8.1038562627475507E-003_f64,&
       -7.1542716007717971E-003_f64,8.0409700959687101E-003_f64,-1.1971496216675665E-002_f64,3.3447503864706296E-002_f64,&
       -8.0865080946708134E-002_f64,0.0000000000000000_f64,0.0000000000000000_f64,4.1405427114159780E-002_f64,&
       -3.1499974643741158E-002_f64,1.2402685052007409E-002_f64,-9.7057499639530559E-003_f64,1.0892166801091781E-002_f64,&
       -1.4048184210643805E-002_f64,4.0942602205223014E-002_f64,-7.9314447220032988E-002_f64,0.19215014611245049_f64,0.0000000000000000_f64    ]


  error = maxval(abs(efield-efield_ref))
  if (error> EQV_TOL) then
     passed = .FALSE.
     print*, 'e field wrong in HB.', error
  end if

  if (passed .EQV. .FALSE.) then
     print*, 'Error in HB.'
  end if
  
  !Reset field info
  !efield = efield_ref

! Reset particle info
  ! Initialize particles from particle_info_ref
  xi = 0.0_f64
  do i_part =1, n_particles
     xi = particle_info_ref(1:3, i_part) 
     call particle_group%group(1)%set_x(i_part, xi)
     xi = particle_info_ref(4:6, i_part)
     call particle_group%group(1)%set_v(i_part, xi)
     xi(1) = particle_info_ref(7, i_part)
     call particle_group%group(1)%set_weights(i_part, xi(1))
  end do


  call propagator%operatorHE( delta_t )

  ! Compare to reference
  ! Particle information after HE application 
  particle_info_check(:,1) = [0.98_f64, 0.42_f64, 0.17_f64,  &
       1.51825545951829_f64, 0.135857172406058_f64, -1.60793903221661_f64, -6.2832_f64 ]
  particle_info_check(:,2) = [0.01_f64,  0.77_f64,  0.35_f64, &
       -1.62982784793027_f64, -0.126336095066152_f64, 1.62297527049672_f64, -6.2832_f64 ]
  
  ! Compare computed values to reference values
  do i_part=1,n_particles
     xi = particle_group%group(1)%get_x(i_part)
     if( maxval(abs(xi-particle_info_check(1:3,i_part))) > EQV_TOL ) then
        passed = .FALSE.
        print*, 'error x, HE', maxval(abs(xi-particle_info_check(1:3,i_part)))
     end if
     xi = particle_group%group(1)%get_v(i_part)
     if( maxval(abs(xi-particle_info_check(4:6,i_part))) > EQV_TOL ) then
        passed = .FALSE.
        print*, 'error v, HE', maxval(abs(xi-particle_info_check(4:6,i_part)))
     end if
     xi(1:1) = particle_group%group(1)%get_charge(i_part)
     if( abs(xi(1)-particle_info_check(7,i_part)) > EQV_TOL) then
        passed = .FALSE.
        print*, 'error wi, HE', abs(xi(1)-particle_info_check(7,i_part))
     end if
  end do

  bfield_ref = [   0.0_f64, -1.4313087480390354_f64,1.0290127257545945_f64,-0.58059964057879554_f64, &
       0.46160118108613918_f64,-0.54248775139143735_f64, 0.85364028678384352_f64, -1.5610928370758248_f64,&
       3.2563954633416743_f64, -4.9397229870713941_f64,0.0000000000000000_f64,0.0000000000000000_f64,&
       1.8656239178996696_f64, -1.3794977781689446_f64, 0.82635101807011024_f64,-0.73290063655155557_f64,&
       0.95820545521666167_f64, -1.5965063952807128_f64,2.9858597112535596_f64, -6.2800369982502637_f64,&
       9.5619939642311902_f64,0.0000000000000000_f64,0.0000000000000000_f64, -2.9822123415050208_f64,&
       2.0579585275696353_f64, -1.0543069943734165_f64, 0.67342432695399046_f64,-0.58924805872488051_f64,&
       0.75752391411492304_f64, -1.2884051245446047_f64,2.6683634975414012_f64, -4.1039532601247997_f64,&
       0.0000000000000000_f64,0.0000000000000000_f64,5.4532999977257788_f64, -3.6308536847449471_f64,&
       1.6903010060719244_f64,-0.79018538518935311_f64, 0.24244991702524621_f64, 0.21635123309039087_f64,&
       -0.79914966478338778_f64,1.9249597286538798_f64, -3.0453351062807208_f64,0.0000000000000000_f64,&
       0.0000000000000000_f64, -10.828907816432556_f64,7.2382469397344451_f64, -3.4288585373759868_f64,&
       1.7349221477313774_f64,-0.82798906147455797_f64, 0.26188383035357882_f64, 0.21429782471894146_f64,&
       -0.89303765543620939_f64,1.5960327389843423_f64,0.0000000000000000_f64,0.0000000000000000_f64,&
       9.0172057358592941_f64, -6.0294839753774676_f64,2.8692827851854674_f64, -1.4835220515610594_f64,&
       0.77396121680065899_f64,-0.38744629389569507_f64, 0.15760065702803561_f64,2.4835816152499593E-002_f64,&
       -0.23066106208431864_f64,0.0000000000000000_f64,0.0000000000000000_f64, -2.9780636527819229_f64,&
       2.0133022922665123_f64,-0.97978126980533009_f64, 0.53942731440281311_f64,-0.33912522017511132_f64,&
       0.27903661500109361_f64,-0.34051853977604685_f64, 0.60195757415914442_f64,-0.85605933947160440_f64,&
       0.0000000000000000_f64,0.0000000000000000_f64,1.6431348958946874_f64, -1.1381636099169161_f64,&
       0.58790419951374961_f64,-0.38260971155682033_f64, 0.34403517885635504_f64,-0.44911604724092391_f64, &
       0.75899591995311833_f64, -1.5431820396734839_f64,2.3203020641854439_f64,0.0000000000000000_f64 ,&
       0.0000000000000000_f64, -1.9828446271925562E-002_f64, 1.3089408815712867E-002_f64,&
       -6.0910456881573764E-003_f64, 3.3123115130791140E-003_f64,-2.3280328143608503E-003_f64, &
       2.1650503214095287E-003_f64,-2.0885320193774425E-003_f64, 1.3202101120268319E-003_f64, &
       1.5373603937173465E-003_f64, 0.0000000000000000_f64,0.0000000000000000_f64,9.6828883269133308E-004_f64,&
       1.2756917513226940E-003_f64,-2.4137610136722391E-003_f64, 3.4602117119508116E-003_f64,&
       -5.1137307409693860E-003_f64, 8.3961481526206427E-003_f64,-1.5065842231292016E-002_f64, &
       3.0194946435612116E-002_f64,-4.3264862191839983E-002_f64, 0.0000000000000000_f64,&
       0.0000000000000000_f64,1.1431600656472019E-002_f64,-1.8177313076959579E-003_f64,&
       -8.0862853092529274E-003_f64, 2.1606658802572894E-002_f64,-4.3465338567205719E-002_f64,&
       7.9112156200274397E-002_f64, -0.13665448815033684_f64, 0.24246998678550771_f64 ,&
       -0.29152627093742706_f64,0.0000000000000000_f64, 0.0000000000000000_f64, -4.8144277990616581E-002_f64,&
       3.5424113693664099E-002_f64,-1.8291462398598635E-002_f64, 9.2759066736463804E-003_f64,&
       -3.1765533731776016E-003_f64,-1.1434280414719612E-003_f64, 3.5390930450869607E-003_f64,&
       -2.6000305170010177E-003_f64,-5.8015024502659608E-003_f64, 0.0000000000000000_f64,&
       0.0000000000000000_f64,8.3449940452530846E-002_f64,-6.0820746970709300E-002_f64, &
       3.1852681611312987E-002_f64,-1.8429394822912039E-002_f64, 1.1570884800432047E-002_f64,&
       -9.0564151147013213E-003_f64, 1.0565455650383632E-002_f64,-1.8400764644523004E-002_f64,&
       2.5981350347853496E-002_f64, 0.0000000000000000_f64,0.0000000000000000_f64, 0.28964672483689674_f64,&
       -0.20095242993450371_f64,9.9084021901044511E-002_f64,-5.3356151805577672E-002_f64, &
       3.0008770933005764E-002_f64,-1.8369909355347252E-002_f64, 1.3483627766437224E-002_f64,&
       -1.3278238357547441E-002_f64, 9.3597961481941307E-003_f64, 0.0000000000000000_f64,&
       0.0000000000000000_f64,-0.13007917087938045_f64,9.0741588887623070E-002_f64,&
       -4.5343846057429228E-002_f64, 2.5707051342623573E-002_f64,-1.7000815416257583E-002_f64, &
       1.4852340624622118E-002_f64,-1.7767940473890017E-002_f64, 2.7413379690316361E-002_f64,&
       -3.1312336749668712E-002_f64, 0.0000000000000000_f64,0.0000000000000000_f64,&
       5.3783351742436807E-002_f64,-3.7461332052327150E-002_f64, 1.8997130247030137E-002_f64,&
       -1.1733778730914291E-002_f64, 9.7031390455984898E-003_f64,-1.1323085713904458E-002_f64, &
       1.6400679639197769E-002_f64,-2.7374875993033999E-002_f64, 3.2429453071299234E-002_f64 , &
       0.0000000000000000_f64,1.9353945328719271_f64, -1.8536449248172784_f64, 0.83864577776560090_f64,&
       -0.58488471624258731_f64, 0.62246982918413662_f64,-0.93068899543253658_f64,1.6692975589714258_f64,&
       -3.3890281129910251_f64,8.7457734886391076_f64, -11.648793942384769_f64, -2.9098951040652778_f64,&
       2.7923921274709484_f64, -1.2934669322408117_f64, 0.94962661187050534_f64, -1.0774147537668373_f64,&
       1.6812189829755049_f64, -3.0762991578845811_f64,6.3022986362439726_f64, -16.334813652549037_f64,&
       21.791671403449062_f64,4.8189867001029665_f64, -4.3984710537392484_f64,1.7102711523701459_f64,&
       -0.76768822034753015_f64, 0.25170136366926316_f64, 0.16899015289774111_f64,&
       -0.70126216142292841_f64,1.6987291374863593_f64, -4.6094746496348389_f64,&
       6.1284330898982695_f64, -9.2985774017641436_f64,8.4792019478116636_f64, &
       -3.3469937656160749_f64,1.5988317850152713_f64,-0.73354895796140851_f64, &
       0.17705618749556848_f64, 0.33351066349222258_f64, -1.0993518052671458_f64,&
       3.1576822636238004_f64, -4.2768142754855756_f64,18.857900413436152_f64, &
       -17.196826579673974_f64,6.8209779011247393_f64, -3.3461157666676322_f64,&
       1.7276188601723992_f64,-0.85850731454190810_f64, 0.33289058273606004_f64,&
       9.6292215685444299E-002_f64, -0.83718388911099262_f64,1.3220571955969189_f64, &
       -5.4450610003146025_f64,5.0320218753151380_f64, -2.0158660424313104_f64,&
       1.0102946596819937_f64,-0.55202253820966352_f64, 0.32760920519069653_f64,&
       -0.23567980755883042_f64, 0.25036626833082221_f64,-0.46888606110690373_f64, &
       0.56372757209702840_f64,2.5403573192090687_f64, -2.3789483422412263_f64, &
       0.97640819068232032_f64,-0.52556618613534367_f64, 0.35062078273010350_f64,&
       -0.32309540964541328_f64, 0.43480340228074310_f64,-0.78587641416445519_f64,&
       1.9483190364547955_f64, -2.5637179654797162_f64, -1.7941501459339815_f64,&
       1.7012346443628528_f64,-0.73076857389330163_f64, 0.44820077816637882_f64,&
       -0.39340955521132576_f64, 0.50633910177402386_f64,-0.84750164445656795_f64,&
       1.6775298309718387_f64, -4.2900885131718347_f64,5.6952484350527062_f64,&
       0.31330764805117828_f64, -9.2066971658742558E-002_f64, 2.9192820230635876E-002_f64,&
       -8.2286754502787999E-003_f64,-5.7651084323681713E-003_f64, 2.5124184171106907E-002_f64,&
       -6.6142793317811879E-002_f64,0.16566950310462683_f64,-0.49999426165361655_f64,&
       1.7029732857599424_f64,-0.44117933520870056_f64, 0.12911741577800570_f64, &
       -4.0853813237011399E-002_f64, 1.0637678332671341E-002_f64, 1.1587325203308541E-002_f64,&
       -4.5581822633149971E-002_f64,0.12054980738783615_f64,-0.30502132529345138_f64,&
       0.92773614875352739_f64, -3.1813047539558390_f64, 0.74228108316870145_f64,&
       -0.22040170867752995_f64,7.3942178096639527E-002_f64,-2.9471754888525683E-002_f64, &
       1.0215590815857845E-002_f64,-2.7024601626700452E-003_f64, 7.2084939363222800E-003_f64,&
       -3.7344923557689126E-002_f64,0.16186666892303361_f64,-0.70450503359172678_f64, &
       -1.3556219741696760_f64, 0.40280322595122614_f64,-0.13623201864174811_f64, &
       5.6927261937705080E-002_f64,-2.4716929721245839E-002_f64, 1.3297063842652296E-002_f64,&
       -1.6745954191609048E-002_f64, 4.2765749320636474E-002_f64, -0.14504578403380763_f64,&
       0.54733250559915658_f64,2.7242738385701060_f64,-0.80549434967878042_f64, 0.27022836314584969_f64,&
       -0.11162379505253028_f64,4.7026181727537489E-002_f64,-2.0385026032874478E-002_f64, &
       1.1838261434105934E-002_f64,-1.6576571181896326E-002_f64, 4.9641604581593821E-002_f64,&
       -0.18549669748675082_f64,-0.89332212976771252_f64, 0.27159049434435067_f64, &
       -9.1730905696584625E-002_f64, 3.7210789050993176E-002_f64,-1.4180610990701821E-002_f64, &
       3.2846452192279926E-003_f64, 3.5081636834812958E-003_f64,-1.1123916827753544E-002_f64, &
       3.0632042174119790E-002_f64,-9.1070871795233876E-002_f64,0.44568802169252708_f64,&
       -0.13571934532244354_f64,4.5163858206679265E-002_f64,-1.7187846739865582E-002_f64, &
       4.4364694063366641E-003_f64, 3.9742688382531774E-003_f64,-1.4799610280439648E-002_f64, &
       3.7461331568126137E-002_f64, -0.11145911028147895_f64, 0.37425963711769195_f64,&
       -0.31055925607579610_f64,9.2912452483029248E-002_f64,-3.0185648947721713E-002_f64,&
       1.0290009006926261E-002_f64, 3.8499915807780894E-004_f64,-1.1282791724401976E-002_f64,&
       3.1669703909726989E-002_f64,-7.9991398309333619E-002_f64, 0.24201578996026032_f64,&
       -0.82651221164450084_f64,8.0838484228645715_f64,5.8619124483450946_f64,6.4228759067796535_f64,&
       6.2394120487780578_f64,6.3104629492927478_f64,6.2892287139556871_f64,6.2892159181580736_f64,&
       6.3113729871190838_f64,6.2430680154751057_f64,6.4667922561443234_f64,3.8978047970416525_f64,&
       6.9861360930695149_f64,6.0475663069910830_f64,6.3962780698204789_f64,6.2478632653415866_f64,&
       6.3214807507686688_f64,6.3084787980750567_f64,6.2901432677983662_f64,6.4070373339924469_f64,&
       5.9850087555468905_f64,10.260636620012736_f64,5.0123948021464830_f64,6.7344947165772417_f64,&
       6.0757108206333417_f64,6.3701882476439424_f64,6.2233733257486676_f64,6.2667449287361476_f64,&
       6.2568417075247025_f64,6.1753335175065232_f64,6.3621261447545345_f64,-0.84399353104649233_f64,&
       8.6511789468161080_f64,5.4276766531698080_f64,6.6422608801554768_f64,6.0651778370304958_f64,&
       6.3268463724664077_f64,6.1745325533295183_f64,6.2601974592071254_f64,6.1592456483104989_f64,&
       6.3754685788248322_f64,20.126038520947709_f64,1.7597005707636679_f64,7.8491051890858996_f64,&
       5.5836029493362371_f64,6.5962287462458100_f64,6.1395251838269509_f64,6.3726907287555186_f64,&
       6.2642826835337857_f64,6.3583962345314333_f64,6.2766676549069640_f64, -2.3548359202202302_f64,&
       7.1876009057446577_f64,6.1565045957323887_f64,6.2508831114007544_f64,6.3678202284657992_f64,&
       6.2313983102179265_f64,6.3457990086661633_f64,6.2581337985712402_f64,6.3382652282898135_f64,&
       6.2596756667123117_f64,9.2414798484700693_f64,6.1113206589048374_f64,6.2712276656217192_f64,&
       6.3396765707461045_f64,6.2434071205389667_f64,6.3290812445786644_f64,6.2651924654174520_f64,&
       6.3169233155354396_f64,6.2610758876607431_f64,6.3394731872014107_f64,4.3626925912216850_f64,&
       6.5730908066238483_f64,6.2230539857362022_f64,6.3009150997180807_f64,6.2981088728870844_f64,&
       6.2814156047014560_f64,6.3048404661554702_f64,6.2770196309160129_f64,6.3280573057354879_f64,&
       6.2092833927874116_f64,5.8263221616197800_f64,6.4043230143863505_f64,6.2620838480817040_f64,&
       6.2758733578019319_f64,6.3576247569642916_f64,6.1256284778305705_f64,6.6974802364313764_f64,&
       5.3150944129376247_f64,9.2098053202404699_f64, -3.6327014087488436_f64,6.9041332640888715_f64,&
       6.0995541258107329_f64,6.3425106519216516_f64,6.2973167637861867_f64,6.2127493006105601_f64,&
       6.5502652624113358_f64,5.6555563567881153_f64,7.9918634267230626_f64,1.1368745441285846_f64,&
       25.002942568107937_f64,5.3896157386254648_f64,6.4899672917536337_f64,6.3003849672488661_f64,&
       6.1173767770708265_f64,6.6359631746728596_f64,5.5615458967968276_f64,7.5831767599446476_f64,&
       3.6696382008382757_f64,12.442788983166107_f64, -7.0433879879510410_f64,8.1253500341944189_f64,&
       5.6569488581954008_f64,6.4832357444924096_f64,6.1863953365615743_f64,6.2547177593662067_f64,&
       6.2547157751182958_f64,6.2516202614950078_f64,5.9643112619421750_f64,7.4061042917374529_f64,&
       1.2985003926581058_f64,2.8050559845582077_f64,7.4585149978231344_f64,5.8525699476074191_f64,&
       6.4589354830340788_f64,6.1892551819573001_f64,6.3567627429895914_f64,6.1798663831923193_f64,&
       6.6175168467235439_f64,5.3133539901155684_f64,9.5197606714248355_f64,8.6397872550882795_f64,&
       5.8228564582805378_f64,6.4041958637599325_f64,6.2653054698131490_f64,6.2791877083844225_f64,&
       6.3302343463629294_f64,6.2517052511815239_f64,6.3433706456506078_f64,6.2784752708852603_f64,&
       5.9942899177245739_f64,5.4463892931816762_f64,6.4156354589699935_f64,6.2679903497888727_f64,&
       6.2730675243093286_f64,6.3397702659863375_f64,6.1989101259390447_f64,6.4689046856671846_f64,&
       5.9418570412950960_f64,7.1817947961230484_f64,4.1024031105536825_f64,6.7422814813857359_f64,&
       6.2060317181705411_f64,6.2986181651563768_f64,6.3139273126426918_f64,6.2285670827740693_f64,&
       6.4265487459900887_f64,6.0080681479823950_f64,6.9219327729547793_f64,4.5553317303825311_f64,11.401524224691773_f64   ]
  
 
  error = maxval(abs(bfield-bfield_ref))
  if (error> EQV_TOL) then
     passed = .FALSE.
     print*, 'b field wrong in HE.', error
  end if

  if (passed .EQV. .FALSE.) then
     print*, 'Error in HE.'
  end if


  if (passed .EQV. .TRUE.) then
     print*, 'PASSED'
  else
     print*, 'FAILED'
     stop
  end if

  particle_group => null()
  call propagator%free()
  call pg%free()
  deallocate(pg)
  deallocate(efield)
  deallocate(efield_ref)
  deallocate(bfield)
  deallocate(bfield_ref)
  deallocate(rho)
  deallocate(rho_local)
  call particle_mesh_coupling%free()
  deallocate(particle_mesh_coupling)
  call maxwell_solver%free()
  deallocate(maxwell_solver)

  call sll_s_halt_collective()

end program test_time_propagator_pic_3d3v_vm_clamped_cef_trafo
