# 
# Summary of commands for BSL-LT-PIC compilation
# 
# ======================================================================
# MCP and ALH
# ======================================================================
#+STARTUP: showeverything
# ======================================================================
# [[shell:header\alh 'README']] (cf [[file:~/alh/bin/headeralh]])
# emacs-keywords authors="MCP and ALH" brief="Summary of commands for BSL-LT-PIC compilation" default=0 org start=26/10/15

# <<<<BSL-LT-PIC_Simulation>>>>	[[file:.]] uses [[[file:../../../../../mcp/../selalib/src/particle_methods/pic_remapped/bsl_lt_pic/CMakeLists.txt::BSL-LT-PIC_Library]]]

* Doxygen
  building: [[elisp:(compile "cd ${SELALIB}/build && make doc")]]
  HTML index: [[selalib:doc/build/html/doxygen/html/index.html]]

* Configuring
** extra packages

    binutils is for gprof, linux-tools is for perf
    [[elisp:(compile "sudo apt-get install -y libopenmpi-dev libfftw3-dev liblapack-dev libhdf5-mpi-dev binutils linux-tools")]]
    
** configuration options

    The current configuration is cached in [[selalib:build/CMakeCache.txt]]

    some configuration options are required for [[file:../CMakeLists.txt]] to build parallel tests
    OPENMP_ENABLED is forced to OFF until further speed tests

    [[shell:rm -rf ~/selalib/build]]
    [[shell:mkdir -p ~/selalib/build]]

    - Debug mode:

      - Quiet:

        [[elisp:(compile "cd ${SELALIB}/build && cmake -DCMAKE_BUILD_TYPE=Debug -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=FALSE -DOPENMP_ENABLED=OFF ../../selalib" t)]]

      - Verbose:

        [[elisp:(compile "cd ${SELALIB}/build && cmake -DCMAKE_BUILD_TYPE=Debug -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=TRUE -DOPENMP_ENABLED=OFF ../../selalib" t)]]

    - Release mode:

      [[elisp:(compile "cd ${SELALIB}/build && cmake -DCMAKE_BUILD_TYPE=Release -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=FALSE -DOPENMP_ENABLED=OFF ../../selalib" t)]]

    - Shaking cmake enough to make it check the whole configuration from scratch again:

      [[shell:rm ${SELALIB}/build/CMakeCache.txt]]
	
* Compiling
   - sequential compile (useful to see compiling errors):
     [[elisp:(compile "cd ${SELALIB}/build && make")]]

   - parallel compile:
     [[elisp:(compile "cd ${SELALIB}/build && make -j $NCPU")]]

* Running
** setup
*** View [[selalib:src/simulations/sim_parallel/pic_vp_2d2v_cart_remapped]] contents

     [[elisp:(startup-persistent-process "rox-filer")]]

*** Parameters file
      file:params_lt_pic_4d.nml
      file:params_simple_pic_4d.nml

   - copy the files in the run directory (launch from build, src or usr directory) :
     cp ../src/simulations/parallel/pic_vp_2d2v_cart_remapped/*.nml ../usr/simulations/sim_parallel/pic_vp_2d2v_cart_remapped/

** Run
*** 

     (NB: mpirun is not required at the moment)

     [[elisp:(compile "${SELALIB}/build/bin/sim_pic_vp_2d2v_cart_remapped params_lt_pic_4d.nml")]]
     [[elisp:(compile "${SELALIB}/build/bin/sim_pic_vp_2d2v_cart_remapped params_simple_pic_4d.nml")]]

*** complete make + run

     [[elisp:(compile "pushd ${SELALIB}/build && make -j $NCPU && popd && ${SELALIB}/build/bin/sim_pic_vp_2d2v_cart_remapped ../params_ltpic_pic_4d.nml")]]

** plot
*** rho_init
**** Generated by [[file:sll_m_sim_pic_vp_2d2v_cart_remapped.F90::rho_init_standPUSH]]
**** Gnuplot script [[file:rho_init_standPUSH.gnu]]
      (generated by [[file:sll_m_sim_pic_vp_2d2v_cart_remapped.F90::rho_init_standPUSH]]).
**** Display [[shell:gnuplot rho_init_standPUSH.gnu --persist]]
*** Ex, Ey
**** Generated by [[file:sll_m_sim_pic_vp_2d2v_cart_remapped.F90::Ex_Ey_output]]
**** Gnuplot scripts [[file:Ex.gnu]] and [[file:Ey.gnu]]
**** Display [[shell:gnuplot Ex.gnu --persist]] and [[shell:gnuplot Ey.gnu --persist]]
*** Autres graphes
-- pour representer les points reconstruits ou bien les points de f_target dont la vitesse est donnee

vx = 3
vy = 0

splot 'target_values_test_init4D.dat' u 1:2:(abs(($3)-vx)<0.01 && abs(($4)-vy)<0.01 ? $6 : 1/0) w p, '' u 1:2:(abs(($3)-vx)<0.01 && abs(($4)-vy)<0.01 ? $5 : 1/0) w p lc "blue"

* <<Debugging>>

     [[elisp:(gdb "gdb -i=mi --args $SELALIB/build/bin/pic_vp_2d2v_cart_remapped/sim_pic_vp_2d2v_cart_remapped params_debug.nml")]]

* Results
   - gnuplot prompt [[elisp:(startup-persistent-process "terminator -x gnuplot")]]
   - gnuplot script generated at runtime [[elisp:(compile "gnuplot --persist rho_init_standPUSH.gnu")]]

* <<Profiling>>
** with gprof

   - configure

     [[elisp:(compile "cd ${SELALIB}/build && cmake -DCMAKE_BUILD_TYPE=Debug -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=TRUE -DOPENMP_ENABLED=OFF -DCMAKE_Fortran_FLAGS='-pg -fprofile-arcs -ftest-coverage' ../../selalib")]]

   - run

     [[elisp:(compile "pushd ${SELALIB}/build && make -j $NCPU && popd && ${SELALIB}/build/bin/sim_pic_vp_2d2v_cart_remapped params_ltpic_pic_4d.nml|tee output.txt")]]

   - Generate profiling reports with [[man:gprof]] (See also [[http://www.thegeekstuff.com/2012/08/gprof-tutorial/]])

     [[elisp:(compile "gprof ../sim_pic_vp_2d2v_cart_remapped gmon.out > func_profile.txt")]]

     [[elisp:(compile "gprof -l ../sim_pic_vp_2d2v_cart_remapped gmon.out > line_profile.txt")]]

** with perf

    from the "linux-tools" package under Debian
    more on perf profiling: [[https://perf.wiki.kernel.org/index.php/Tutorial]]

*** configure

     -ggdb option is required to see source lines in the perf annotate output

     [[elisp:(compile "cd ${SELALIB}/build && cmake -DCMAKE_BUILD_TYPE=Release -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=TRUE -DOPENMP_ENABLED=OFF -DCMAKE_Fortran_FLAGS='-ggdb' ../../selalib")]]

*** compile

     [[elisp:(compile "cd ${SELALIB}/build && make -j $NCPU")]]

*** run
**** basic

     - input data file for profiling: file:params_perf.nml

     - plain run for timing reference (instrumented runs should not be more than 5% slower than this)

       [[elisp:(compile "$SELALIB/build/bin/sim_pic_vp_2d2v_cart_remapped ../params_perf.nml | tee perf_ref_`date +%y%m%d%H%M`.txt")]]

     - basic stats ([[man:perf-stat]])

       [[elisp:(compile "perf stat -d --log-fd 1 ../sim_pic_vp_2d2v_cart_remapped ../params_perf.nml | tee perf_stat_`date +%y%m%d%H%M`.txt")]]

     - other valuable counters that may be worth testing

     perf stat -B -e cache-references,cache-misses,cycles,instructions,branches,faults,migrations ../sim_pic_vp_2d2v_cart_remapped ../params_ltpic_pic_4d.nml

**** instrumented

      Statistics are recorded in binary form in run/perf.data ([[man:perf-record]]). The sampling value of 100000 is chosen
      according to [[http://sandsoftwaresound.net/perf/perf-tut-profile-hw-events/]]. "-o" is required to prevent perf from
      sending binary data into the output pipe

      - cpu-cycles

        [[elisp:(compile "STAMP=`date +%y%m%d%H%M` && perf record -e cpu-cycles -c 100000 -o perf.data $SELALIB/build/bin/sim_pic_vp_2d2v_cart_remapped ../params_perf.nml | tee perf_cpu_$STAMP.txt && cp perf.data perf_cpu_$STAMP.data")]]

      - stalled-cycles-frontend

        [[elisp:(compile "STAMP=`date +%y%m%d%H%M` && perf record -e stalled-cycles-frontend -c 100000 -o perf.data $SELALIB/build/bin/sim_pic_vp_2d2v_cart_remapped ../params_perf.nml | tee perf_stall_$STAMP.txt && cp perf.data perf_stall_$STAMP.data")]]

*** report
**** whole code with file:perf_report

     [[elisp:(compile "./perf_report")]]

**** annotating source code with file:perf_annotate
***** [[selalib:src/pic_utilities/lt_pic_4d_utilities.F90::sll_lt_pic_4d_write_f_on_grid_or_deposit][sll_lt_pic_4d_write_f_on_grid_or_deposit]]

       [[elisp:(compile "./perf_annotate __sll_lt_pic_4d_utilities_MOD_sll_lt_pic_4d_write_f_on_grid_or_deposit")]]

***** [[selalib:src/pic_utilities/sll_representation_conversion.F90::cell_offset_to_global_extended][cell_offset_to_global_extended]]

       [[elisp:(compile "./perf_annotate __sll_representation_conversion_module_MOD_cell_offset_to_global_extended")]]

* Selalib Ctests check

   [[elisp:(compile "cd ${SELALIB}/build && ctest -R pic_vp_2d2v_cart_remapped")]]

* clear/clean

   [[elisp:(compile "cd ${SELALIB}/build && make clear")]]
   [[elisp:(compile "cd ${SELALIB}/build && make clean")]]

* <<File_info>>

* <<File_info>>

# Local Variables:
# mode:org
# mode:visual-line
# ispell-local-dictionary:"british"
# coding:utf-8
# eval:(flyspell-prog-mode)
# eval:(outline-minor-mode)
# End:
# LocalWords: emacs
