# 
# Summary of commands for BSL-LT-PIC compilation
# 
# ======================================================================
# MCP and ALH
# ======================================================================
#+STARTUP: showeverything
# ======================================================================
# [[shell:header\alh 'README']] (cf [[file:~/alh/bin/headeralh]])
# emacs-keywords authors="MCP and ALH" brief="Summary of commands for BSL-LT-PIC compilation" default=0 org start=26/10/15

# <<<<BSL-LT-PIC_Simulation>>>> [[file:.]] uses [[[selalib:src/particle_methods/pic_remapped/bsl_lt_pic/CMakeLists.txt::BSL-LT-PIC_Library]]]

* Doxygen [[elisp:(compile "cd ${SELALIB}/build && make doc")][build]], [[selalib:doc/build/html/doxygen/html/index.html][index]]
* Configuring
** extra packages
    binutils is required for gprof, linux-tools for perf:
    [[elisp:(compile "sudo apt-get install -y libopenmpi-dev libfftw3-dev liblapack-dev libhdf5-mpi-dev binutils linux-tools")]]
** configuration options
   Mode [[elisp:(compile "cd ${SELALIB}/build && cmake -DCMAKE_BUILD_TYPE=Debug -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=FALSE -DOPENMP_ENABLED=OFF ../../selalib" t)][quiet]], [[elisp:(compile "cd ${SELALIB}/build && cmake -DCMAKE_BUILD_TYPE=Debug -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=TRUE -DOPENMP_ENABLED=OFF ../../selalib" t)][verbose]], [[elisp:(compile "cd ${SELALIB}/build && cmake -DCMAKE_BUILD_TYPE=Release -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=FALSE -DOPENMP_ENABLED=OFF ../../selalib" t)][optimized]]. The current configuration is cached in [[selalib:build/CMakeCache.txt]].  Some configuration options are
   required for [[file:../CMakeLists.txt]] to build parallel tests OPENMP_ENABLED is forced to OFF until further speed tests.  Cleaning and
   recreating the build directory is done with [[shell:rm -rf ~/selalib/build]] and [[shell:mkdir -p ~/selalib/build]].  Reinitialising cmake
   configuration choices is done by [[shell:rm ${SELALIB}/build/CMakeCache.txt][deleting]] [[selalib:build/CMakeCache.txt][CMakeCache.txt]].
* Compiling: [[elisp:(compile "cd ${SELALIB}/build && make")][sequential]], [[elisp:(compile "cd ${SELALIB}/build && make -j $NCPU")][parallel]]
* Running
** Parameters file file:params_lt_pic_4d.nml or file:params_simple_pic_4d.nml
** Create [[shell:mkdir -p run][run]] directory then run [[elisp:(compile "cd run && ${SELALIB}/build/bin/sim_pic_vp_2d2v_cart_remapped ../params_lt_pic_4d.nml")][lt_pic]] or [[elisp:(compile "cd run && ${SELALIB}/build/bin/sim_pic_vp_2d2v_cart_remapped params_simple_pic_4d.nml")][simple_pic]]
** Plots with [[man:gnuplot][gnuplot]]
*** [[shell:cd run && gnuplot rho_init_standPUSH.gnu --persist][rho_init_standPUSH]] (script [[file:run/rho_init_standPUSH.gnu][rho_init_standPUSH.gnu]] generated by [[file:sll_m_sim_pic_vp_2d2v_cart_remapped.F90::rho_init_standPUSH][rho_init_standPUSH]])
*** [[shell:cd run && gnuplot Ex.gnu --persist][Ex]] and [[shell:cd run && gnuplot Ey.gnu --persist][Ey]] (scripts [[file:run/Ex.gnu][Ex.gnu]] and [[file:run/Ey.gnu][Ey.gnu]] generated by [[file:sll_m_sim_pic_vp_2d2v_cart_remapped.F90::Ex_Ey_output][Ex_Ey_output]])
*** [[shell:cd run && gnuplot f_slice.gnu --persist][f_slice]] (script [[file:run/f_slice.gnu][f_slice.gnu]] generated by [[file:sll_m_sim_pic_vp_2d2v_cart_remapped.F90::f_slice][f_slice]])
*** [[shell:gnuplot -e "plot 'run/logE_standPush.dat' w l" --persist][logE]] (data generated at [[file:sll_m_sim_pic_vp_2d2v_cart_remapped.F90::logE_standPush][logE_standPush]])
*** Autres graphes
-- pour representer les points reconstruits ou bien les points de f_target dont la vitesse est donnee

vx = 3
vy = 0

splot 'target_values_test_init4D.dat' u 1:2:(abs(($3)-vx)<0.01 && abs(($4)-vy)<0.01 ? $6 : 1/0) w p, '' u 1:2:(abs(($3)-vx)<0.01 && abs(($4)-vy)<0.01 ? $5 : 1/0) w p lc "blue"

* <<Debugging>> [[elisp:(gdb "gdb -i=mi --args $SELALIB/build/bin/pic_vp_2d2v_cart_remapped/sim_pic_vp_2d2v_cart_remapped params_debug.nml")]]

* <<Profiling>>
** with gprof

   - configure

     [[elisp:(compile "cd ${SELALIB}/build && cmake -DCMAKE_BUILD_TYPE=Debug -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=TRUE -DOPENMP_ENABLED=OFF -DCMAKE_Fortran_FLAGS='-pg -fprofile-arcs -ftest-coverage' ../../selalib")]]

   - run

     [[elisp:(compile "pushd ${SELALIB}/build && make -j $NCPU && popd && ${SELALIB}/build/bin/sim_pic_vp_2d2v_cart_remapped params_ltpic_pic_4d.nml|tee output.txt")]]

   - Generate profiling reports with [[man:gprof]] (See also [[http://www.thegeekstuff.com/2012/08/gprof-tutorial/]])

     [[elisp:(compile "gprof ../sim_pic_vp_2d2v_cart_remapped gmon.out > func_profile.txt")]]

     [[elisp:(compile "gprof -l ../sim_pic_vp_2d2v_cart_remapped gmon.out > line_profile.txt")]]

** with perf

    from the "linux-tools" package under Debian
    more on perf profiling: [[https://perf.wiki.kernel.org/index.php/Tutorial]]

*** configure

     -ggdb option is required to see source lines in the perf annotate output

     [[elisp:(compile "cd ${SELALIB}/build && cmake -DCMAKE_BUILD_TYPE=Release -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=TRUE -DOPENMP_ENABLED=OFF -DCMAKE_Fortran_FLAGS='-ggdb' ../../selalib")]]

*** compile

     [[elisp:(compile "cd ${SELALIB}/build && make -j $NCPU")]]

*** run
**** basic

     - input data file for profiling: file:params_perf.nml

     - plain run for timing reference (instrumented runs should not be more than 5% slower than this)

       [[elisp:(compile "$SELALIB/build/bin/sim_pic_vp_2d2v_cart_remapped ../params_perf.nml | tee perf_ref_`date +%y%m%d%H%M`.txt")]]

     - basic stats ([[man:perf-stat]])

       [[elisp:(compile "perf stat -d --log-fd 1 ../sim_pic_vp_2d2v_cart_remapped ../params_perf.nml | tee perf_stat_`date +%y%m%d%H%M`.txt")]]

     - other valuable counters that may be worth testing

     perf stat -B -e cache-references,cache-misses,cycles,instructions,branches,faults,migrations ../sim_pic_vp_2d2v_cart_remapped ../params_ltpic_pic_4d.nml

**** instrumented

      Statistics are recorded in binary form in run/perf.data ([[man:perf-record]]). The sampling value of 100000 is chosen
      according to [[http://sandsoftwaresound.net/perf/perf-tut-profile-hw-events/]]. "-o" is required to prevent perf from
      sending binary data into the output pipe

      - cpu-cycles

        [[elisp:(compile "STAMP=`date +%y%m%d%H%M` && perf record -e cpu-cycles -c 100000 -o perf.data $SELALIB/build/bin/sim_pic_vp_2d2v_cart_remapped ../params_perf.nml | tee perf_cpu_$STAMP.txt && cp perf.data perf_cpu_$STAMP.data")]]

      - stalled-cycles-frontend

        [[elisp:(compile "STAMP=`date +%y%m%d%H%M` && perf record -e stalled-cycles-frontend -c 100000 -o perf.data $SELALIB/build/bin/sim_pic_vp_2d2v_cart_remapped ../params_perf.nml | tee perf_stall_$STAMP.txt && cp perf.data perf_stall_$STAMP.data")]]

*** report
**** whole code with file:perf_report

     [[elisp:(compile "./perf_report")]]

**** annotating source code with file:perf_annotate
***** [[selalib:src/pic_utilities/lt_pic_4d_utilities.F90::sll_lt_pic_4d_write_f_on_grid_or_deposit][sll_lt_pic_4d_write_f_on_grid_or_deposit]]

       [[elisp:(compile "./perf_annotate __sll_lt_pic_4d_utilities_MOD_sll_lt_pic_4d_write_f_on_grid_or_deposit")]]

***** [[selalib:src/pic_utilities/sll_representation_conversion.F90::cell_offset_to_global_extended][cell_offset_to_global_extended]]

       [[elisp:(compile "./perf_annotate __sll_representation_conversion_module_MOD_cell_offset_to_global_extended")]]

* Selalib Ctests check

   [[elisp:(compile "cd ${SELALIB}/build && ctest -R pic_vp_2d2v_cart_remapped")]]

* clear/clean

   [[elisp:(compile "cd ${SELALIB}/build && make clear")]]
   [[elisp:(compile "cd ${SELALIB}/build && make clean")]]

* <<File_info>>

# Local Variables:
# mode:org
# mode:visual-line
# ispell-local-dictionary:"british"
# coding:utf-8
# eval:(flyspell-prog-mode)
# eval:(outline-minor-mode)
# End:
# LocalWords: emacs
