program test_fftw3
use, intrinsic :: iso_c_binding
implicit none
include 'fftw3.f03'

type(C_PTR) :: fw, bw
complex(C_DOUBLE_COMPLEX), dimension(:,:), pointer :: rhot
integer(C_SIZE_T) :: sz_rhot
type(C_PTR) :: p_rhot
integer :: nc_x, nc_y
real(8), dimension(:,:), allocatable :: rho
integer :: i
real(8) :: t0, t1


call cpu_time(t0)
nc_x = 128
nc_y = 128
allocate(rho(nc_x,nc_y))

sz_rhot = int((nc_x/2+1)*nc_y,C_SIZE_T)
p_rhot = fftw_alloc_complex(sz_rhot)
call c_f_pointer(p_rhot, rhot, [nc_x/2+1,nc_y])

fw = fftw_plan_dft_r2c_2d(nc_y,nc_x,rho,rhot,FFTW_MEASURE)
bw = fftw_plan_dft_c2r_2d(nc_y,nc_x,rhot,rho,FFTW_MEASURE)

do i = 1, 10
  call fftw_execute_dft_r2c(fw, rho, rhot)
  call fftw_execute_dft_c2r(bw, rhot, rho)
end do

call fftw_free(p_rhot)
call fftw_destroy_plan(fw)
call fftw_destroy_plan(bw)

call cpu_time(t1)

write(*,"('CPU time =', g15.3)") t1-t0

end program test_fftw3
