# 
# 4d_vp_lt_pic_cartesian simulation
# 
# ======================================================================
# MCP and ALH
# ======================================================================
#+STARTUP: showeverything
# ======================================================================
# headeralh authors="MCP and ALH" brief="4d_vp_lt_pic_cartesian simulation" default=0 org

* Directory structure

  (Same directory structure as [[file:../sim_4d_vlasov_poisson_PIC_cartesian]])

  test_4d_vp_lt_pic_cartesian   -- executable
  params_lt_pic_4d.nml          -- input file
  README                        -- info (this file)
  run/                          -- output directory

* HOWTO
** Source location
   [[file:simulation_4d_vp_lt_pic_cartesian.F90]]
   file:unit_test_4d_vp_lt_pic_cartesian.F90
	
** Parameter file
   file:params_lt_pic_4d.nml
   file:../../../../usr/simulations/simulations_parallel/4d_vp_lt_pic_cartesian/params_lt_pic_4d.nml

** Configuring
   - extra packages: (binutils is for gprof)
     [[elisp:(compile "sudo apt-get install -y sudo apt-get install libopenmpi-dev libfftw3-dev liblapack-dev libhdf5-mpi-dev binutils")]]
    
   - configuration options:
     some configuration options are required for [[file:../CMakeLists.txt]] to build parallel tests
     OPENMP_ENABLED=OFF is forced to OFF until further speed tests

     [[shell:mkdir -p ../../../../build]]

     Debug mode:
     [[elisp:(compile "cd ../../../../build && cmake -DCMAKE_BUILD_TYPE=Debug -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=TRUE -DOPENMP_ENABLED=OFF ../src")]]

     Release mode:
     [[elisp:(compile "cd ../../../../build && cmake -DCMAKE_BUILD_TYPE=Release -DHDF5_PARALLEL_ENABLED=ON -DCMAKE_VERBOSE_MAKEFILE=FALSE -DOPENMP_ENABLED=OFF ../src")]]

   - Shaking cmake enough to make it check the whole configuration from scratch again:
     [[shell:rm ../../../../build/CMakeCache.txt]]
	
** Compiling
   - First complete initial make (to solve missing dependencies issues).
     [[elisp:(compile "cd ../../../../build && make -j $NCPU")]]

   - Next makes
     [[elisp:(compile "cd ../../../../build && make test_4d_vp_lt_pic_cartesian && make install")]]

   - "install" depends on everything else:
     [[elisp:(compile "cd ../../../../build && make -j $NCPU install")]]

** Running
   - Create output directory if missing
     [[elisp:(compile "mkdir ../../../../usr/simulations/simulations_parallel/4d_vp_lt_pic_cartesian/run")]]

   - Run simulation within directory (NB: mpirun is not required at the moment)
     [[elisp:(compile "cd ../../../../usr/simulations/simulations_parallel/4d_vp_lt_pic_cartesian/run && ../test_4d_vp_lt_pic_cartesian ../params_lt_pic_4d.nml")]]

   - complete make install + run:
     [[elisp:(compile "cd ../../../../build && make -j $NCPU install && cd ../usr/simulations/simulations_parallel/4d_vp_lt_pic_cartesian/run && ../test_4d_vp_lt_pic_cartesian ../params_lt_pic_4d.nml")]]

   - for later mpi runs: mpirun -np 4 ../test_4d_vp_lt_pic_cartesian ../params_pic_4d.nml

** Results
   - Run gnuplot script generated at runtime
     [[elisp:(compile "cd ../../../../usr/simulations/simulations_parallel/4d_vp_lt_pic_cartesian/run && gnuplot --persist rho_init_standPUSH.gnu")]]

** Profiling
   - Add "-pg -fprofile-arcs -ftest-coverage" in Fortran flags in
     [[file:~/mcp/selalib/src/CMakeModules/FortranConfig.cmake::CMAKE_Fortran_FLAGS_DEBUG]] and recompile

   - Generate profiling reports with [[man:gprof]]. See also [[http://www.thegeekstuff.com/2012/08/gprof-tutorial/]]
     [[elisp:(compile "cd ../../../../usr/simulations/simulations_parallel/4d_vp_lt_pic_cartesian/run && gprof ../test_4d_vp_lt_pic_cartesian gmon.out|tee func_profile.txt")]]
     [[elisp:(compile "cd ../../../../usr/simulations/simulations_parallel/4d_vp_lt_pic_cartesian/run && gprof -l ../test_4d_vp_lt_pic_cartesian gmon.out|tee line_profile.txt")]]

** Ctests
   [[elisp:(compile "cd ../../../../build && ctest -R 4d_vp_lt_pic_cartesian")]]

** clean
   [[elisp:(compile "cd ../../../../build && make clean")]]


* <<File_info>>
# Local Variables:
# mode:org
# mode:visual-line
# ispell-local-dictionary:"british"
# coding:utf-8
# End:
